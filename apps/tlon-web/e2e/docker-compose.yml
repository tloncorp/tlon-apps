version: '3.8'

services:
  # Shard 1
  e2e-shard-1:
    image: tlon-e2e-runner
    build:
      context: ../../..
      dockerfile: apps/tlon-web/e2e/Dockerfile
    container_name: tlon-e2e-shard-1
    environment:
      - SHARD=1
      - TOTAL_SHARDS=4
      - CI=true
      - FORCE_EXTRACTION=true
      - E2E_S3_ENDPOINT=${E2E_S3_ENDPOINT}
      - E2E_S3_ACCESS_KEY_ID=${E2E_S3_ACCESS_KEY_ID}
      - E2E_S3_SECRET_ACCESS_KEY=${E2E_S3_SECRET_ACCESS_KEY}
      - E2E_S3_BUCKET_NAME=${E2E_S3_BUCKET_NAME}
      - E2E_S3_REGION=${E2E_S3_REGION:-us-east-1}
    volumes:
      - ./test-results/shard-1:/workspace/apps/tlon-web/test-results
      - ./test-results/shard-1-report:/workspace/apps/tlon-web/playwright-report
    command: ["pnpm e2e:shard"]
    networks:
      - e2e-network

  # Shard 2
  e2e-shard-2:
    image: tlon-e2e-runner
    build:
      context: ../../..
      dockerfile: apps/tlon-web/e2e/Dockerfile
    container_name: tlon-e2e-shard-2
    environment:
      - SHARD=2
      - TOTAL_SHARDS=4
      - CI=true
      - FORCE_EXTRACTION=true
      - E2E_S3_ENDPOINT=${E2E_S3_ENDPOINT}
      - E2E_S3_ACCESS_KEY_ID=${E2E_S3_ACCESS_KEY_ID}
      - E2E_S3_SECRET_ACCESS_KEY=${E2E_S3_SECRET_ACCESS_KEY}
      - E2E_S3_BUCKET_NAME=${E2E_S3_BUCKET_NAME}
      - E2E_S3_REGION=${E2E_S3_REGION:-us-east-1}
    volumes:
      - ./test-results/shard-2:/workspace/apps/tlon-web/test-results
      - ./test-results/shard-2-report:/workspace/apps/tlon-web/playwright-report
    command: ["pnpm e2e:shard"]
    networks:
      - e2e-network

  # Shard 3
  e2e-shard-3:
    image: tlon-e2e-runner
    build:
      context: ../../..
      dockerfile: apps/tlon-web/e2e/Dockerfile
    container_name: tlon-e2e-shard-3
    environment:
      - SHARD=3
      - TOTAL_SHARDS=4
      - CI=true
      - FORCE_EXTRACTION=true
      - E2E_S3_ENDPOINT=${E2E_S3_ENDPOINT}
      - E2E_S3_ACCESS_KEY_ID=${E2E_S3_ACCESS_KEY_ID}
      - E2E_S3_SECRET_ACCESS_KEY=${E2E_S3_SECRET_ACCESS_KEY}
      - E2E_S3_BUCKET_NAME=${E2E_S3_BUCKET_NAME}
      - E2E_S3_REGION=${E2E_S3_REGION:-us-east-1}
    volumes:
      - ./test-results/shard-3:/workspace/apps/tlon-web/test-results
      - ./test-results/shard-3-report:/workspace/apps/tlon-web/playwright-report
    command: ["pnpm e2e:shard"]
    networks:
      - e2e-network

  # Shard 4
  e2e-shard-4:
    image: tlon-e2e-runner
    build:
      context: ../../..
      dockerfile: apps/tlon-web/e2e/Dockerfile
    container_name: tlon-e2e-shard-4
    environment:
      - SHARD=4
      - TOTAL_SHARDS=4
      - CI=true
      - FORCE_EXTRACTION=true
      - E2E_S3_ENDPOINT=${E2E_S3_ENDPOINT}
      - E2E_S3_ACCESS_KEY_ID=${E2E_S3_ACCESS_KEY_ID}
      - E2E_S3_SECRET_ACCESS_KEY=${E2E_S3_SECRET_ACCESS_KEY}
      - E2E_S3_BUCKET_NAME=${E2E_S3_BUCKET_NAME}
      - E2E_S3_REGION=${E2E_S3_REGION:-us-east-1}
    volumes:
      - ./test-results/shard-4:/workspace/apps/tlon-web/test-results
      - ./test-results/shard-4-report:/workspace/apps/tlon-web/playwright-report
    command: ["pnpm e2e:shard"]
    networks:
      - e2e-network

networks:
  e2e-network:
    driver: bridge

# Alternative compose configuration for dynamic shard counts
# Use with: docker-compose --profile shard-N up